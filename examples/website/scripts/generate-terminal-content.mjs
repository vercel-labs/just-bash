#!/usr/bin/env node

/**
 * Generates terminal-content.ts from the main repo files.
 * Run this before build to update the embedded content.
 */

import fs from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const repoRoot = path.resolve(__dirname, "../../..");
const outputFile = path.resolve(
  __dirname,
  "../app/components/terminal-content.ts"
);

// Read repo files
const readme = fs.readFileSync(path.join(repoRoot, "README.md"), "utf-8");
const license = fs.readFileSync(path.join(repoRoot, "LICENSE"), "utf-8");
const packageJson = JSON.parse(
  fs.readFileSync(path.join(repoRoot, "package.json"), "utf-8")
);
const agentsMd = fs.readFileSync(path.join(repoRoot, "AGENTS.npm.md"), "utf-8");

// Escape backticks and ${} for template literals
function escapeTemplate(str) {
  return str.replace(/\\/g, "\\\\").replace(/`/g, "\\`").replace(/\$\{/g, "\\${");
}

// Generate simplified package.json
const simplifiedPackageJson = JSON.stringify(
  {
    name: packageJson.name,
    version: packageJson.version,
    description: packageJson.description,
    repository: packageJson.repository,
    homepage: packageJson.homepage,
    type: packageJson.type,
    main: packageJson.main,
    types: packageJson.types,
    author: packageJson.author,
    license: packageJson.license,
  },
  null,
  2
);

const content = `// Auto-generated by scripts/generate-terminal-content.mjs
// Do not edit manually - run "pnpm generate" to regenerate

import pkg from "../../../../package.json";

export const version = pkg.version;

// Command outputs
export const CMD_ABOUT = \`just-bash v\${pkg.version}
A TypeScript bash interpreter with in-memory filesystem.
Designed for AI agents needing a secure, sandboxed environment.

Custom commands:
  about       About just-bash
  install     Installation instructions
  github      GitHub repository

Or try any bash command: ls, cat, echo, grep, awk, jq, sed, etc.
Type 'help' for a list of all built-in commands.
\`;

export const CMD_INSTALL = \`npm install just-bash

Usage:
  import { Bash } from "just-bash";
  const bash = new Bash();
  const result = await bash.exec("echo hello");
\`;

export const CMD_GITHUB = "https://github.com/vercel-labs/just-bash\\n";

// File contents (generated from repo)
export const FILE_README = \`${escapeTemplate(readme)}\`;

export const FILE_LICENSE = \`${escapeTemplate(license)}\`;

export const FILE_PACKAGE_JSON = \`${escapeTemplate(simplifiedPackageJson)}\`;

export const FILE_AGENTS_MD = \`${escapeTemplate(agentsMd)}\`;

export const FILE_WTF_IS_THIS = \`# WTF Is This?

This is an interactive demo of **just-bash** running entirely in your browser, with an AI agent that can explore the source code.

## Architecture

\\\`\\\`\\\`
+----------------------------------------------------------+
|                        BROWSER                           |
|  +----------+    +----------+    +----------------+      |
|  | xterm.js |--->| just-bash|--->| Virtual FS     |      |
|  | Terminal |    | (browser)|    | (in-memory)    |      |
|  +----------+    +----------+    +----------------+      |
|       |                                                  |
|       | \\\`agent\\\` command                                 |
|       v                                                  |
|  +--------------------------------------------------+   |
|  |          SSE Stream (Server-Sent Events)         |   |
|  +--------------------------------------------------+   |
+----------------------------|-----------------------------+
                             |
                             v
+----------------------------------------------------------+
|                        SERVER                            |
|  +-------------+    +----------+    +----------------+   |
|  |ToolLoopAgent|--->| bash-tool|--->| just-bash      |   |
|  | (AI SDK)    |    |          |    | + OverlayFS    |   |
|  |Claude Haiku |    | - bash   |    |                |   |
|  +-------------+    | - read   |    | Real files:    |   |
|                     | - write  |    | - just-bash/   |   |
|                     +----------+    | - bash-tool/   |   |
|                                     +----------------+   |
+----------------------------------------------------------+
\\\`\\\`\\\`

## Components

### 1. xterm.js (Browser Terminal)
- Renders a real terminal in the browser
- Handles keyboard input, cursor, colors, scrolling
- Supports ANSI escape codes for styling

### 2. just-bash (Browser)
- Pure TypeScript bash interpreter
- Runs locally in browser for regular commands
- In-memory virtual filesystem with pre-loaded files
- No network calls for basic commands like \\\`ls\\\`, \\\`cat\\\`, \\\`grep\\\`

### 3. \\\`agent\\\` Command
- Custom command that calls the server
- Sends conversation history to \\\`/api/agent\\\`
- Streams response via Server-Sent Events (SSE)
- Displays tool calls (bash commands, file reads) in real-time

### 4. ToolLoopAgent (Server - AI SDK)
- Uses Anthropic's Claude Haiku model
- Loops automatically: think → tool call → observe → think → ...
- Stops after 20 tool calls or when done
- Streams responses back to browser

### 5. bash-tool (Server)
- Provides tools for the AI agent:
  - \\\`bash\\\` - Execute bash commands
  - \\\`readFile\\\` - Read file contents
  - \\\`writeFile\\\` - Write files (disabled in this demo)
- Integrates with just-bash sandbox

### 6. OverlayFS (Server)
- Overlays real filesystem (this source code) as read-only
- Agent can explore just-bash and bash-tool source
- Writes go to memory, not disk

## Data Flow

1. You type \\\`agent "how does grep work?"\\\`
2. Browser just-bash runs the \\\`agent\\\` command
3. Command POSTs to \\\`/api/agent\\\` with message history
4. Server creates ToolLoopAgent with bash-tool
5. Agent thinks, calls tools (bash, readFile), observes results
6. Each step streams back as SSE events
7. Browser displays tool calls and final response
8. Response added to conversation history for multi-turn chat

## Links

- **just-bash**: https://github.com/vercel-labs/just-bash
- **bash-tool**: https://github.com/vercel-labs/bash-tool
- **AI SDK**: https://ai-sdk.dev
- **xterm.js**: https://xtermjs.org
\`;
`;

fs.writeFileSync(outputFile, content);
console.log(`Generated ${outputFile}`);
